<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="gridmappr">
<title>Using gridmap layouts • gridmappr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using gridmap layouts">
<meta property="og:description" content="gridmappr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">gridmappr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9000</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/generate-gridmaps.html">Generating gridmap layouts</a>
    <a class="dropdown-item" href="../articles/use-gridmaps.html">Using gridmap layouts</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/rogerbeecham/gridmappr/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using gridmap layouts</h1>
                        <h4 data-toc-skip class="author">Roger
Beecham</h4>
            
            <h4 data-toc-skip class="date">2023-02-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rogerbeecham/gridmappr/blob/HEAD/vignettes/use-gridmaps.Rmd" class="external-link"><code>vignettes/use-gridmaps.Rmd</code></a></small>
      <div class="d-none name"><code>use-gridmaps.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette reproduces ideas discussed in <a href="https://journals.sagepub.com/doi/10.1177/0308518X19850580" class="external-link">Beecham
and Slingsby 2019</a>, using ggplot2 to create gridmaps analysing the
geography of travel-to-work between London boroughs.</p>
</div>
<div class="section level2">
<h2 id="setup">Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>The following libraries are required to run this vignette:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://forcats.tidyverse.org/" class="external-link">forcats</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/ggtext/" class="external-link">ggtext</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rogerbeecham/gridmappr" class="external-link">gridmappr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data">Data<a class="anchor" aria-label="anchor" href="#data"></a>
</h2>
<p>The travel-to-work data contains origin-destination pairs
representing every borough-to-borough commute combination: a
<code>tibble</code> containing 9,801 observations and five
variables:</p>
<ul>
<li>
<code>o_bor</code> Borough origin.</li>
<li>
<code>d_bor</code> Borough destination.</li>
<li>
<code>occ_type</code> Occupation type of commute:
<code>1_managers_senior</code>, <code>2_professional</code>,
<code>3_associate_professional</code>, <code>4_administrative</code>,
<code>5_trade</code>, <code>6_caring_leisure</code>,
<code>7_sales_customer</code>, <code>8_machine_operatives</code>,
<code>9_elementary</code>.</li>
<li>
<code>count</code> Count of number of commutes of occupation type
between origin-destination borough pair.</li>
<li>
<code>is_prof</code> Whether the occupation type is professional or
non-professional.</li>
</ul>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">london_ttw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="st">"london_ttw.csv"</span><span class="op">)</span></span></code></pre></div>
<p>To analyse commuting between London boroughs by occupation type we
differentiate between:</p>
<ul>
<li>
<em>jobs</em> located in a borough, accessed by workers living in
London; and</li>
<li>
<em>workers</em> living in a borough, who access jobs in London</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Jobs located in borough.</span></span>
<span><span class="va">jobs</span> <span class="op">&lt;-</span> <span class="va">london_ttw</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">d_bor</span>, <span class="va">occ_type</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>count<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, is_prof<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">first</a></span><span class="op">(</span><span class="va">is_prof</span><span class="op">)</span>, type<span class="op">=</span><span class="st">"jobs"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">type</span>, bor<span class="op">=</span><span class="va">d_bor</span>, <span class="va">occ_type</span>, <span class="va">is_prof</span>, <span class="va">count</span><span class="op">)</span></span>
<span><span class="co"># Workers living in borough.</span></span>
<span><span class="va">workers</span> <span class="op">&lt;-</span> <span class="va">london_ttw</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">o_bor</span>, <span class="va">occ_type</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>count<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, is_prof<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">first</a></span><span class="op">(</span><span class="va">is_prof</span><span class="op">)</span>, type<span class="op">=</span><span class="st">"workers"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">type</span>, bor<span class="op">=</span><span class="va">o_bor</span>, <span class="va">occ_type</span>, <span class="va">is_prof</span>, <span class="va">count</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="generate-allocation-and-make-grid">Generate allocation and make grid<a class="anchor" aria-label="anchor" href="#generate-allocation-and-make-grid"></a>
</h2>
<p>We use <code><a href="../reference/points_to_grid.html">points_to_grid()</a></code>, specified with targeted
spacers, to get a solution close to the <a href="https://github.com/aftertheflood/londonsquared" class="external-link">LondonSquared</a>
layout. See the vignette <a href="">Generate gridmaps</a> for a fuller
explanation of <code><a href="../reference/points_to_grid.html">points_to_grid()</a></code> and
<code><a href="../reference/make_grid.html">make_grid()</a></code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_row</span> <span class="op">&lt;-</span> <span class="fl">7</span></span>
<span><span class="va">n_col</span> <span class="op">&lt;-</span> <span class="fl">8</span></span>
<span><span class="va">spacers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">6</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">7</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">7</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">6</span>, <span class="fl">8</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">4</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">6</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">7</span>, <span class="fl">7</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pts</span> <span class="op">&lt;-</span> <span class="va">london_boroughs</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">area_name</span>, x <span class="op">=</span> <span class="va">easting</span>, y <span class="op">=</span> <span class="va">northing</span><span class="op">)</span></span>
<span><span class="va">solution</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/points_to_grid.html">points_to_grid</a></span><span class="op">(</span><span class="va">pts</span>, <span class="va">n_row</span>, <span class="va">n_col</span>, compactness <span class="op">=</span> <span class="fl">1</span>, <span class="va">spacers</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gridmap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_grid.html">make_grid</a></span><span class="op">(</span><span class="va">london_boroughs</span>, <span class="va">n_row</span>, <span class="va">n_col</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">solution</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="gridmap-as-thematic-map-geom_sf">Gridmap as thematic map (<code>geom_sf</code>)<a class="anchor" aria-label="anchor" href="#gridmap-as-thematic-map-geom_sf"></a>
</h2>
<p>Since we have created simple feature object for the layout with
<code><a href="../reference/make_grid.html">make_grid()</a></code>, it is straightforward to generate thematic
gridmaps in ggplot2: using <a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link"><code>geom_sf()</code></a>
alongside ggplot2’s standard <code>geom</code> layers and grammar. In
the map below we encode counts of jobs and workers by borough as
proportional symbols (with <code><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point()</a></code>) and
<code><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid()</a></code> the plot according to two categorical
variables: occupation type (collapsed to <em>professional</em> or
<em>non-professional</em>) and whether jobs or workers in the borough
are counted over.</p>
<p><img src="../reference/figures/lb-commutes.svg" width="100%"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">gridmap</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">workers</span><span class="op">)</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"area_name"</span><span class="op">=</span><span class="st">"bor"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">area_name</span>, <span class="va">is_prof</span>, <span class="va">type</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>count<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span>, x<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">first</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, y<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/nth.html" class="external-link">first</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    is_prof<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">is_prof</span>, <span class="st">"professional"</span>, <span class="st">"non-professional"</span><span class="op">)</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"professional"</span>, <span class="st">"non-professional"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    type<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">type</span>, levels<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"workers"</span>, <span class="st">"jobs"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"#EEEEEE"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>size<span class="op">=</span><span class="va">count</span>, colour<span class="op">=</span><span class="va">is_prof</span><span class="op">)</span>,  alpha<span class="op">=</span><span class="fl">.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>size<span class="op">=</span><span class="va">count</span>, colour<span class="op">=</span><span class="va">is_prof</span><span class="op">)</span>, fill<span class="op">=</span><span class="st">"transparent"</span>, pch<span class="op">=</span><span class="fl">21</span>, stroke<span class="op">=</span><span class="fl">.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="va">is_prof</span><span class="op">~</span><span class="va">type</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#4d004b"</span>, <span class="st">"#00441b"</span><span class="op">)</span>, guide<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_colour_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#4d004b"</span>, <span class="st">"#00441b"</span><span class="op">)</span>, guide<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> </span></code></pre></div>
<p>A quick explanation of the ggplot2 spec:</p>
<ol style="list-style-type: decimal">
<li>
<em>Data</em>: Counts of workers and jobs (<code>type</code>) by
borough, collapsed over <em>professional</em> or
<em>non-professional</em> occupation types (<code>is_prof</code>).
Casting <code>is_prof</code> and <code>type</code> to factor variables
gives us control over the order in which they appear in the plot.</li>
<li>
<em>Encoding</em>: the proportional symbols are positioned at the
centroids of borough grid cells (<code>x</code>, <code>y</code>), sized
according to <code>count</code> of jobs or workers and coloured
according to occupation type (<code>is_prof</code>).</li>
<li>
<em>Marks</em>: <code><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point()</a></code> for proportional symbols
and <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf()</a></code> for grid outline.</li>
<li>
<em>Scale</em>: <code>scale_fill/colour_manual()</code> for
hue-based associating occupation type and <code><a href="https://ggplot2.tidyverse.org/reference/scale_size.html" class="external-link">scale_size()</a></code>for
controlling size of points that encode counts.<br>
</li>
<li>
<em>Facets</em>: <code><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap()</a></code> on workers/jobs summary
<code>type</code> and high-level occupation type
(<code>is_prof</code>).</li>
</ol>
<!-- In the right column job-rich boroughs in central and inner London -- Westminster, City of London and Tower Hamlets (for professionals) --  can be identified. By contrast frequencies of workers living in boroughs, accessing jobs in any borough in London, tend to vary less, although the City of London is an exception. Notice also that there are larger numbers of professionals than non-professional workers living in inner west London boroughs (Wandsworth, Lambeth, Hammersmith, Kenisngton & Chelsea) and comparatively more non-professionals libing in outer London boroughs, easpecially to the east (Havering, Barking & Dagenham, Bexley). -->
</div>
<div class="section level2">
<h2 id="gridmap-as-geographically-arranged-geoms-with-facet_grid">Gridmap as geographically-arranged <code>geoms</code> with
<code>facet_grid</code><a class="anchor" aria-label="anchor" href="#gridmap-as-geographically-arranged-geoms-with-facet_grid"></a>
</h2>
<p>It is straightforward with standard ggplot2 to allocate more detailed
graphics into a geographic arrangement. In the example below are bar
charts summarising the number of workers (left-pointing bars) and jobs
(right-pointing bars) by occupation type, the full nine standard classes
are shown, in each borough with a gridmap arrangement.</p>
<p><img src="../reference/figures/lb-commutes-occ.svg" width="100%"></p>
<!-- An advantage of gridmap layouts is that they free-up graphic space, thereby enabling potentially detailed charts to be shown with geographic context (e.g. [Beecham et al. 2021](https://www.mdpi.com/2220-9964/10/4/213)).  -->
<p>This time we create a staged dataset for
plotting(<code>plot_data</code>). In the graphic above, jobs and workers
are differentiated by varying the direction of bars: pointing to the
right for jobs, to the left for workers. This is achieved in data
staging by a slight hack – changing the polarity of counts by occupation
depending on the summary <code>type</code>. The counts are further
locally (borough-level) scaled. For each borough we find its modal
category count of jobs/workers by occupation type and scale all other
counts of jobs and workers by occupation type relative to this modal
category. Doing so irrespective of whether jobs or workers are being
summarised over, we can distinguish between job-rich boroughs with
longer bars pointing to the right (Westminster); resident/worker-rich
boroughs with longer bars pointing to the left (Wandsworth); and outer
London boroughs that are more self-contained (Hillingdon).</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Combine jobs and workers summaries.</span></span>
<span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">workers</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Borough-scaled counts (maximum).</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">bor</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>count<span class="op">=</span><span class="va">count</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Selectively change sign and reverse factor for bars of descending occ status.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span> count<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">type</span><span class="op">==</span><span class="st">"jobs"</span>, <span class="va">count</span>, <span class="op">-</span><span class="va">count</span><span class="op">)</span>, occ_type<span class="op">=</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_rev.html" class="external-link">fct_rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">occ_type</span><span class="op">)</span><span class="op">)</span> <span class="op">)</span></span></code></pre></div>
<p>The ggplot2 spec for creating the bar charts is:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bor_select</span> <span class="op">&lt;-</span> <span class="st">"Westminster"</span></span>
<span><span class="va">plot_data</span>  <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">bor</span><span class="op">==</span><span class="va">bor_select</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">count</span>, y<span class="op">=</span><span class="va">occ_type</span>, fill<span class="op">=</span><span class="va">is_prof</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">.5</span>, width<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fl">0</span>, linewidth<span class="op">=</span><span class="fl">.4</span>, colour<span class="op">=</span><span class="st">"#ffffff"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate</a></span><span class="op">(</span><span class="st">"text"</span>, x<span class="op">=</span><span class="fl">1</span>, y<span class="op">=</span><span class="fl">5</span>, label<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">bor_select</span>, <span class="st">"^.{3}"</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">.7</span>, hjust<span class="op">=</span><span class="fl">1</span>, size<span class="op">=</span><span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#00441b"</span>, <span class="st">"#4d004b"</span><span class="op">)</span>, guide<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> </span></code></pre></div>
<ol style="list-style-type: decimal">
<li>
<em>Data</em>: The staged (<code>plot_data</code>) object, filtered
on <em>selected</em> boroughs for exploration purposes (identified with
<code>bor_select</code>)</li>
<li>
<em>Encoding</em>: Bars whose horizontal position (<code>x=</code>)
varies according to <code>count</code> and vertical position
(<code>y=</code>) according <code>occ_type</code>, filled on high-level
(<em>professional</em> / <em>non-professional</em> –
<code>is_prof</code>) occupation type.</li>
<li>
<em>Marks</em>: <code><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col()</a></code> for bars.</li>
<li>
<em>Scale</em>: <code><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual()</a></code> for associating
occupation type, <code><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous()</a></code> for making sure
workers/jobs bars use the same scale.</li>
<li>
<em>Setting</em>: <code><a href="https://ggplot2.tidyverse.org/reference/annotate.html" class="external-link">annotate()</a></code> to provide a borough label
within the plot space – the middle right of the plot. We use
<code><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">stringr::str_extract()</a></code> to pull out the first three letters
of the borough name. `</li>
</ol>
<p>Remembering that gridmap layouts created by
<code><a href="../reference/points_to_grid.html">points_to_grid()</a></code> define <em>row</em> and <em>column</em>
identifiers for each spatial unit in the original geography, it is easy
to imagine how this can be turned into a gridmap using
<code>ggplot2</code>’s built-in faceting. The only substantive update to
the spec is that we supply <code>row</code> and <code>col</code>
identifiers to <code><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid()</a></code>, with a slight hack on the
<code>col</code> variable as <code>gridmappr</code>’s origin [min-row,
min-col] is the bottom-left cell in the grid whereas for
<code><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid()</a></code> the origin is the top-left. Generating the
graphic entirely with standard (built-in) ggplot2 gives many options for
plot customisation – adding layers, annotations and other elements as in
the example graphic.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_data</span>  <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Join on solution to IDs for gridmap layout.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">solution</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"bor"</span><span class="op">=</span><span class="st">"area_name"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">count</span>, y<span class="op">=</span><span class="va">occ_type</span>, fill<span class="op">=</span><span class="va">is_prof</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">.5</span>, width<span class="op">=</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_vline</a></span><span class="op">(</span>xintercept<span class="op">=</span><span class="fl">0</span>, linewidth<span class="op">=</span><span class="fl">.4</span>, colour<span class="op">=</span><span class="st">"#ffffff"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">solution</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fl">1</span>, y<span class="op">=</span><span class="fl">5</span>, label<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">area_name</span>, <span class="st">"^.{3}"</span><span class="op">)</span><span class="op">)</span>, alpha<span class="op">=</span><span class="fl">.7</span>, hjust<span class="op">=</span><span class="fl">1</span>, size<span class="op">=</span><span class="fl">4</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Pass row col IDs from solution for gridmap layout.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="op">-</span><span class="va">row</span><span class="op">~</span><span class="va">col</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>limits<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html" class="external-link">scale_fill_manual</a></span><span class="op">(</span>values<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"#00441b"</span>, <span class="st">"#4d004b"</span><span class="op">)</span>, guide<span class="op">=</span><span class="st">"none"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span> strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="gridmap-as-geographically-arranged-geom_sfs-od-maps">Gridmap as geographically arranged <code>geom_sfs</code> (OD
Maps)<a class="anchor" aria-label="anchor" href="#gridmap-as-geographically-arranged-geom_sfs-od-maps"></a>
</h2>
<p>So far we have generated gridmap graphics as standard thematic maps
using a polygon object and <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf()</a></code>; and as geographically
arranged plot objects (glyphmaps) with <code><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid()</a></code>.
Combining both approaches – placing standard thematic maps with a
further geographical arrangement (using <code><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid()</a></code>) –
allows the creation of <a href="https://www.gicentre.net/featuredpapers#/woodvisualisation2010/" class="external-link">OD
Maps</a>. With this map-within-map layout, we can look at flows of
commuters <em>between</em> London boroughs.</p>
<p><img src="../reference/figures/lb-commutes-odmap.svg" width="100%"></p>
<p>Again we create a staged dataset (<code>plot_data</code>). Counts of
commuter flows by occupation type (<em>professional</em> and
<em>non-professional</em>) are calculated along with the proportion of
jobs that are professional (51%, <code>global_prop</code>). If we were
to randomly sample an OD (borough-borough) commute pair, we might expect
this proportion to appear when counting up the number of
<em>professional</em> and <em>non-professional</em> occupation types
present in that commute. For each origin-destination pair (OD), we
generate expected counts by multiplying the total number of commutes
present in an OD pair by this <code>global_prop</code>, and from here
signed residuals (<code>resid</code>), identifying whether there are
greater or fewer professionals commuting that OD pair than would be
expected. Note that these are like <a href="https://www.tandfonline.com/doi/epdf/10.1179/caj.1981.18.1.32?needAccess=true" class="external-link">signed
chi-scores</a> in that rather than expressing differences in observed
counts as a straight proportion of expected counts (dividing by expected
counts), we apply a power transform to the denominator. This has the
effect of also giving saliency to differences that are large in absolute
terms. You could try varying this exponent (maybe between 0.5-1.5) to
see its effect on residuals encoded in the OD Maps.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">london_ttw</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">o_bor</span>, <span class="va">d_bor</span>, <span class="va">is_prof</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span>count<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">count</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html" class="external-link">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">is_prof</span>, values_from <span class="op">=</span> <span class="va">count</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>non_prof <span class="op">=</span> <span class="va">`FALSE`</span>, prof <span class="op">=</span> <span class="va">`TRUE`</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>global_prof<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">prof</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">prof</span><span class="op">+</span><span class="va">non_prof</span><span class="op">)</span><span class="op">)</span><span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">d_bor</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    count<span class="op">=</span><span class="va">prof</span><span class="op">+</span><span class="va">non_prof</span><span class="op">+</span><span class="fl">.0001</span>, </span>
<span>    obs<span class="op">=</span><span class="va">prof</span><span class="op">+</span><span class="fl">.0001</span>, </span>
<span>    exp<span class="op">=</span><span class="op">(</span><span class="va">global_prof</span><span class="op">*</span><span class="va">count</span><span class="op">)</span>, </span>
<span>    resid<span class="op">=</span><span class="op">(</span><span class="va">obs</span><span class="op">-</span><span class="va">exp</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">exp</span><span class="op">^</span><span class="fl">.7</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> </span></code></pre></div>
<p>The ggplot2 spec for creating the OD map:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bbox_grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">gridmap</span><span class="op">)</span></span>
<span><span class="va">width</span> <span class="op">&lt;-</span> <span class="va">bbox_grid</span><span class="op">$</span><span class="va">xmax</span><span class="op">-</span><span class="va">bbox_grid</span><span class="op">$</span><span class="va">xmin</span>  </span>
<span><span class="va">height</span> <span class="op">&lt;-</span> <span class="va">bbox_grid</span><span class="op">$</span><span class="va">ymax</span><span class="op">-</span><span class="va">bbox_grid</span><span class="op">$</span><span class="va">ymin</span>  </span>
<span><span class="va">range_resid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">plot_data</span><span class="op">$</span><span class="va">resid</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot</span> <span class="op">&lt;-</span> <span class="va">plot_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">gridmap</span> <span class="op">|&gt;</span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">area_name</span>, d_col<span class="op">=</span><span class="va">col</span>, d_row<span class="op">=</span><span class="va">row</span><span class="op">)</span>,by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"d_bor"</span><span class="op">=</span><span class="st">"area_name"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">gridmap</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>o_x<span class="op">=</span><span class="va">x</span>,o_y<span class="op">=</span><span class="va">y</span>, <span class="va">area_name</span><span class="op">)</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"o_bor"</span><span class="op">=</span><span class="st">"area_name"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    bor_label<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">o_bor</span><span class="op">==</span><span class="va">d_bor</span>,<span class="va">d_bor</span>,<span class="st">""</span><span class="op">)</span>,</span>
<span>    bor_focus<span class="op">=</span><span class="va">o_bor</span><span class="op">==</span><span class="va">d_bor</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html" class="external-link">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>fill<span class="op">=</span><span class="va">resid</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"#616161"</span>, size<span class="op">=</span><span class="fl">0.15</span>, alpha<span class="op">=</span><span class="fl">0.9</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">plot_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">bor_focus</span><span class="op">)</span>, </span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">o_x</span>, y<span class="op">=</span><span class="va">o_y</span>, label<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">o_bor</span>, <span class="st">"^.{1}"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>            colour<span class="op">=</span><span class="st">"#252525"</span>, alpha<span class="op">=</span><span class="fl">0.9</span>, size<span class="op">=</span><span class="fl">2.1</span>,</span>
<span>            hjust<span class="op">=</span><span class="st">"centre"</span>, vjust<span class="op">=</span><span class="st">"middle"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">plot_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">bor_focus</span><span class="op">)</span>, </span>
<span>            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">bbox_grid</span><span class="op">$</span><span class="va">xmax</span>, y<span class="op">=</span><span class="va">bbox_grid</span><span class="op">$</span><span class="va">ymin</span>, label<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">o_bor</span>, <span class="st">"^.{3}"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>            colour<span class="op">=</span><span class="st">"#252525"</span>, alpha<span class="op">=</span><span class="fl">0.6</span>, size<span class="op">=</span><span class="fl">3.5</span>,</span>
<span>            hjust<span class="op">=</span><span class="st">"right"</span>, vjust<span class="op">=</span><span class="st">"bottom"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">coord_sf</a></span><span class="op">(</span>crs<span class="op">=</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">plot_data</span><span class="op">)</span>, datum<span class="op">=</span><span class="cn">NA</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="op">-</span><span class="va">d_row</span><span class="op">~</span><span class="va">d_col</span>, shrink<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller</a></span><span class="op">(</span>palette<span class="op">=</span><span class="st">"PRGn"</span>, direction<span class="op">=</span><span class="op">-</span><span class="fl">1</span>, breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">range_resid</span>, <span class="fl">0</span>, <span class="va">range_resid</span><span class="op">)</span>, labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"low prof"</span>, <span class="st">"avg"</span>, <span class="st">"high prof"</span><span class="op">)</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="va">range_resid</span>, <span class="va">range_resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.spacing<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/grid/unit.html" class="external-link">unit</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="st">"lines"</span><span class="op">)</span>,</span>
<span>    strip.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, strip.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span></span></code></pre></div>
<ul>
<li>
<em>1. Data</em>:
<ul>
<li>Take the staged dataset and join twice on the <code>gridmap</code>
dataset.</li>
<li>The first join, on <code>d_bor</code>. The map in the figure is a
D-OD map. The larger (<em>focus</em>) grid cells correspond to
destinations; the smaller cells are origins coloured according to
commuter flows into the larger (focus) cells. When joining
<code>plot_data</code> on destination (<code>d_bor</code>) we do not
need the geometry data, so drop it, but we do need the cell IDs
(<code>col</code>, <code>row</code>) to supply to the ggplot2 facet.
Note that these variables are renamed in the <code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select()</a></code>.</li>
<li>The second join , on <code>o_bor</code>. As origins are the small
maps, we retain the <code>geometry</code> data as well as the geographic
centroid of origin borough grid cells (<code>x</code>, <code>y</code>).
Again these variables are renamed in the <code><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select()</a></code>.</li>
<li>Finally in the <code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate()</a></code> we generate a new variable
identifying the borough in focus (<code>bor_focus</code>), destination
in this case, and a text label variable for annotating plots on this
(<code>bor_label</code>).</li>
</ul>
</li>
<li>
<em>2. Encoding</em>:
<ul>
<li>Gridmap cells are coloured according to the calculated resdiuals
(<code>fill=resid</code>).</li>
<li>Text labels for destination (focus) boroughs are drawn in the
bottom-right corner of larger cells. Note that the coordinate space here
is that from the <code>gridmap</code> dataset and so the
<code>x,y</code> location of borough labels are derived from the
bounding box object (<code>bbox_grid</code>), calculated during data
staging. Single letter annotations are also positioned where small
origin cells match the focus (destination) borough. These additional
labels are positioned using the grid centroids <code>o_x, o_y</code>
from <code>plot_data</code>.</li>
</ul>
</li>
<li>
<em>3. Marks</em>: <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf()</a></code> for drawing the small
gridcell maps; <code><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text()</a></code> for drawing the labels.</li>
<li>
<em>4. Scale</em>: <code><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller()</a></code> for a
diverging colour scheme using the ColorBrewer <code>PRGn</code> palette
and made symmetrical on 0 by manually setting
<code>limits()</code>.</li>
<li>
<em>5. Facets</em>: <code><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid()</a></code> for effecting the
map-within-map layout.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Roger Beecham.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
