<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-UK">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Using gridmap layouts • gridmappr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Using gridmap layouts">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">gridmappr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/use-gridmaps.html">Using gridmap layouts</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/rogerbeecham/gridmappr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Using gridmap layouts</h1>
                        <h4 data-toc-skip class="author">Roger
Beecham</h4>
            
            <h4 data-toc-skip class="date">2025-08-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/rogerbeecham/gridmappr/blob/master/vignettes/use-gridmaps.Rmd" class="external-link"><code>vignettes/use-gridmaps.Rmd</code></a></small>
      <div class="d-none name"><code>use-gridmaps.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This article demonstrates how <code>gridmappr</code>-generated
layouts can be used with standard ggplot2 to create different gridmap
designs. Gridmaps are encoded:</p>
<ol style="list-style-type: decimal">
<li>In the same way as thematic maps, using <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf()</a></code>;</li>
<li>As information-rich ‘glyphmaps’, using ggplot2’s layered
<code>geoms</code> and <code>facet_grid(row~col)</code>;</li>
<li>As gridmap-arranged thematic maps, or <a href="https://openaccess.city.ac.uk/id/eprint/537/" class="external-link">OD Maps</a>, using
<code>facet_grid(row~col)</code> together with
<code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf()</a></code>.</li>
</ol>
</div>
<div class="section level2">
<h2 id="setup-and-data">Setup and data<a class="anchor" aria-label="anchor" href="#setup-and-data"></a>
</h2>
<p>The following libraries are required to run this article:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Tidyverse</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://forcats.tidyverse.org/" class="external-link">forcats</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span>
<span><span class="co"># Spatial</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">geosphere</span><span class="op">)</span></span>
<span><span class="co"># Gridmaps</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/rogerbeecham/gridmappr" class="external-link">gridmappr</a></span><span class="op">)</span></span>
<span><span class="co"># Alternatives</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hafen/geofacet" class="external-link">geofacet</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_void</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The only dataset needed is the <code>simple features</code> file of
the 96 départements in France (<code>france_deps</code>) that ships with
<code>gridmappr</code>. Some of the graphics demonstrated do rely on a
derived dataset from this file. In the code below, we create a full
‘origin-destination’ (OD) dataset for each département pair (so 96^2 OD
pairs), calculating the straight-line distance bewteen département
centroids.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Département names and centroids that serve as "destinations".</span></span>
<span><span class="va">dests</span> <span class="op">&lt;-</span> <span class="va">france_deps</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">name_prefecture</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dests<span class="op">=</span><span class="st">"dests"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">dests</span>, d_name<span class="op">=</span><span class="va">name</span>, d_x<span class="op">=</span><span class="va">x</span>, d_y<span class="op">=</span><span class="va">y</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span>.by<span class="op">=</span><span class="va">dests</span><span class="op">)</span></span>
<span><span class="co"># Calculate pairwise distancess between OD département pairs.</span></span>
<span><span class="va">france_ods</span> <span class="op">&lt;-</span> <span class="va">france_deps</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">name_prefecture</span><span class="op">)</span> <span class="op">|&gt;</span>  </span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>origins<span class="op">=</span><span class="st">"origins"</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">origins</span>, o_name<span class="op">=</span><span class="va">name</span>, o_x<span class="op">=</span><span class="va">x</span>, o_y<span class="op">=</span><span class="va">y</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dests<span class="op">=</span><span class="va">dests</span><span class="op">$</span><span class="va">data</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">dests</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html" class="external-link">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>   <span class="co"># Calculate distance and express in kms.</span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>dep_dist<span class="op">=</span><span class="fu"><a href="https://rdrr.io/pkg/geosphere/man/distHaversine.html" class="external-link">distHaversine</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">o_y</span>, <span class="va">o_x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">d_y</span>, <span class="va">d_x</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/rm.html" class="external-link">rm</a></span><span class="op">(</span><span class="va">dests</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="generate-allocation-and-build-polygon-object-with-make_grid">Generate allocation and build polygon object with
<code>make_grid()</code><a class="anchor" aria-label="anchor" href="#generate-allocation-and-build-polygon-object-with-make_grid"></a>
</h2>
<p>The main function of <code>gridmappr</code>,
<code><a href="../reference/points_to_grid.html">points_to_grid()</a></code>, is described in the top-level package
description. The same parameterisation of that function is used here to
achieve a reasonable allocation of French départements, with selected
grid dimensions and spacers.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Grid dimensions.</span></span>
<span><span class="va">n_row</span> <span class="op">&lt;-</span> <span class="fl">13</span></span>
<span><span class="va">n_col</span> <span class="op">&lt;-</span> <span class="fl">12</span></span>
<span><span class="co"># Spacers to separate Corsica from mainland.</span></span>
<span><span class="va">spacers</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">11</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">11</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">11</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">10</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">10</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Point centroids for real départements.</span></span>
<span><span class="va">pts</span> <span class="op">&lt;-</span> <span class="va">france_deps</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span>area_name <span class="op">=</span> <span class="va">name</span>, x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">y</span><span class="op">)</span></span>
<span><span class="co"># Derive layout solution.</span></span>
<span><span class="va">solution</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/points_to_grid.html">points_to_grid</a></span><span class="op">(</span><span class="va">pts</span>, <span class="va">n_row</span>, <span class="va">n_col</span>, <span class="fl">.6</span>, <span class="va">spacers</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/france-grids.svg"></p>
<p>Now a layout has been generated, we create a corresponding polygon
object in order for the layout to be plotted. This can be achieved with
<code><a href="../reference/make_grid.html">make_grid()</a></code>. The function takes an <a href="https://r-spatial.github.io/sf/index.html" class="external-link"><code>sf</code></a>
data frame of ‘real’ geography and returns an <code>sf</code> data frame
representing a grid, with variables identifying <em>column</em> and
<em>row</em> IDs (bottom left is origin) and geographic centroids of
grid squares. The gridded object can then be joined on a gridmap
solution returned from <code><a href="../reference/points_to_grid.html">points_to_grid()</a></code> in order to create
an object in which each grid cell corresponds to a gridmap allocation
position.</p>
<p><code><a href="../reference/make_grid.html">make_grid()</a></code> takes the following arguments:</p>
<ul>
<li>
<code>sf_file</code> An sf object the grid is to be passed
over.</li>
<li>
<code>n_row</code> Number of rows in grid.</li>
<li>
<code>n_col</code> Number of columns in grid.</li>
</ul>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Pass a grid over real départements.</span></span>
<span><span class="va">grid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_grid.html">make_grid</a></span><span class="op">(</span><span class="va">france_deps</span>, <span class="va">n_row</span>, <span class="va">n_col</span><span class="op">)</span></span></code></pre></div>
<p>Cells of the grid that have a département allocated to them are then
isolated by joining the gridded object (<code>grid</code>) on the layout
<code>solution</code>. Below the grid file is plotted using
<code>ggplot2</code>’s <a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link"><code>geom_sf</code></a>
geom.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Plot layout solution.</span></span>
<span><span class="va">grid</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">solution</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Draw original geog.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">france_deps</span>, fill<span class="op">=</span><span class="st">"#d9d9d9"</span>, colour<span class="op">=</span><span class="st">"#FFFFFF"</span>, linewidth <span class="op">=</span> <span class="fl">.3</span>, alpha<span class="op">=</span><span class="fl">.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Draw grid cell candidates.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"transparent"</span>, colour <span class="op">=</span> <span class="st">"#969696"</span>, linewidth <span class="op">=</span> <span class="fl">.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Draw grid cells allocated.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">area_name</span><span class="op">)</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"#451C14"</span>, fill<span class="op">=</span><span class="st">"#F1DDD1"</span>, linewidth <span class="op">=</span> <span class="fl">.3</span>, alpha<span class="op">=</span><span class="fl">.8</span><span class="op">)</span> </span></code></pre></div>
<p><img src="../reference/figures/france-grid.svg"></p>
</div>
<div class="section level2">
<h2 id="gridmap-as-thematic-map-with-geom_sf">Gridmap as thematic map with <code>geom_sf()</code><a class="anchor" aria-label="anchor" href="#gridmap-as-thematic-map-with-geom_sf"></a>
</h2>
<p>Since we have a simple features object for the layout with
<code><a href="../reference/make_grid.html">make_grid()</a></code>, it is straightforward to generate thematic
gridmaps using <a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link"><code>geom_sf()</code></a>
alongside ggplot2’s standard <code>geom</code> layers and grammar.</p>
<p>In the map below the perimeter of départements is encoded as
proportional symbols with <code><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point()</a></code>, positioned at the
grid centroid of the cells to which each département is assigned.</p>
<p><img src="../reference/figures/france-bubble.svg"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Find the cell size of grids -- for label positioning.</span></span>
<span><span class="va">cell_size</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">grid</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html" class="external-link">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">cell_width</span> <span class="op">&lt;-</span> <span class="va">cell_size</span><span class="op">$</span><span class="va">xmax</span> <span class="op">-</span> <span class="va">cell_size</span><span class="op">$</span><span class="va">xmin</span>  </span>
<span><span class="va">cell_height</span> <span class="op">&lt;-</span> <span class="va">cell_size</span><span class="op">$</span><span class="va">ymax</span> <span class="op">-</span> <span class="va">cell_size</span><span class="op">$</span><span class="va">ymin</span></span>
<span></span>
<span><span class="co"># Plot as a proportional symbol map.</span></span>
<span><span class="va">grid</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># Identify cells that form the layout.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">solution</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Record and attach the perimeter of each département.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">france_deps</span> <span class="op">|&gt;</span> </span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>perimeter<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_perimeter</a></span><span class="op">(</span><span class="va">geometry</span><span class="op">)</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>              <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>              <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">name</span>, <span class="va">perimeter</span><span class="op">)</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"area_name"</span><span class="op">=</span><span class="st">"name"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Plot grey cell background.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>fill<span class="op">=</span><span class="st">"#d9d9d9"</span>, colour<span class="op">=</span><span class="st">"#ffffff"</span>, linewidth<span class="op">=</span><span class="fl">.5</span>, alpha<span class="op">=</span><span class="fl">.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Plot real geography of France as an outline.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">france_deps</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>is_corse<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html" class="external-link">str_detect</a></span><span class="op">(</span><span class="va">name</span>, <span class="st">"Corse"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>            <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">is_corse</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>          fill<span class="op">=</span><span class="st">"transparent"</span>, colour<span class="op">=</span><span class="st">"#525252"</span>, linewidth<span class="op">=</span><span class="fl">.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Plot proportional symbols.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span>, size<span class="op">=</span><span class="va">perimeter</span><span class="op">)</span>, colour<span class="op">=</span><span class="st">"#a50f15"</span>, fill<span class="op">=</span><span class="st">"#fcbba1"</span>, pch<span class="op">=</span><span class="fl">21</span>, alpha<span class="op">=</span><span class="fl">.9</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Plot text labels in bottom right of grid cells.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">x</span><span class="op">+</span><span class="fl">.48</span> <span class="op">*</span><span class="va">cell_width</span>, y<span class="op">=</span><span class="va">y</span><span class="op">-</span><span class="fl">.48</span><span class="op">*</span><span class="va">cell_height</span>, </span>
<span>                                           label<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">area_name</span>, <span class="st">"^.{3}"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            colour<span class="op">=</span><span class="st">"#252525"</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, size<span class="op">=</span><span class="fl">2</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span>, </span>
<span>            hjust<span class="op">=</span><span class="st">"right"</span>, vjust<span class="op">=</span><span class="st">"bottom"</span>, face<span class="op">=</span><span class="st">"Bold"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_size.html" class="external-link">scale_size</a></span><span class="op">(</span>guide<span class="op">=</span><span class="st">"none"</span><span class="op">)</span></span></code></pre></div>
<p>A quick explanation of the ggplot2 spec:</p>
<ol style="list-style-type: decimal">
<li>
<em>Data</em>: We join the gridded object (<code>grid</code>) on the
layout <code>solution</code>, then on <code>france_deps</code>, a simple
features file containing the real geographies of the départements. In
the <code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate()</a></code>, we calculate the perimeters from this file
and then drop out the geometry. Note that we also record the size of
each grid cell in the <code>grid</code> object – this is to help with
placing labels, and potentially other symbols or chart elements, on our
map.</li>
<li>
<em>Encoding</em>: the proportional symbols are positioned at the
centroids of département grid cells (<code>x</code>, <code>y</code>),
sized according to <code>perimeter</code>.</li>
<li>
<em>Marks</em>: <code><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point()</a></code> for proportional symbols
and <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf()</a></code> for grid outline and outline of the real
geography of France. We want to collapse the outline separately for
Corsica and to achieve this we use <code><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by()</a></code> on a derived
variable identifying départements that are on Corsica
(<code>is_corse</code>).</li>
</ol>
</div>
<div class="section level2">
<h2 id="gridmap-as-geographically-arranged-geoms-with-facet_grid">Gridmap as geographically-arranged <code>geoms</code> with
<code>facet_grid()</code><a class="anchor" aria-label="anchor" href="#gridmap-as-geographically-arranged-geoms-with-facet_grid"></a>
</h2>
<p>In the example above, we render gridmaps in the same way as a
thematic map. The gridded layout may resolve some of the occlusion were
proportional symbols located in their real geographic position. However,
we are not showing complex or multivariate structure, as is intended
with gridmap arrangements.</p>
<p>There are of course many interesting data that we <em>could</em>
represent on French départements. In the graphics below, we show the 1D
distribution in the inverse distance to the neighbouring départements of
<em>Paris</em> and <em>Corse-du-Sud</em>. Not a terribly exciting
statistic, but fine for this illustrative article. Paris has three
départements that are very close; <em>Corse-du-Sud</em> has one
immediate neighbour on Corsica and many on the mainland that are some
distance away.</p>
<p><img src="../reference/figures/france-dist-comp.svg" style="width:40.0%"></p>
<p>We can generate small multiple faceted plots of each of these, in
standard ggplot2 using <a href="https://ggplot2-book.org/facet.html" class="external-link">faceting</a>. Eyeballing this
full graphic, there are certain départements which must be in reasonably
close proximity to one another (cells containing the longer bars). Using
<a href="https://ggplot2-book.org/facet.html#facet-grid" class="external-link">facet_grid()</a>,
we can effect a spatial arrangement of these plots. Doing so confirms
what might have been expected: Paris is distinctive, subdividing into
several départements that are close in geographic space.</p>
<p><img src="../reference/figures/france-dist-spat.svg"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_data</span> <span class="op">&lt;-</span> <span class="va">france_ods</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">solution</span>, by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"d_name"</span><span class="op">=</span><span class="st">"area_name"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>d_row<span class="op">=</span><span class="va">row</span>, d_col<span class="op">=</span><span class="va">col</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    dep_dist<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">o_name</span><span class="op">==</span><span class="va">d_name</span>,<span class="fl">10</span><span class="op">^</span><span class="fl">8</span>,<span class="va">dep_dist</span><span class="op">)</span>,</span>
<span>    min_dist<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">dep_dist</span><span class="op">)</span>,</span>
<span>    dep_dist<span class="op">=</span><span class="va">min_dist</span><span class="op">/</span><span class="op">(</span><span class="va">dep_dist</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">d_name</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/desc.html" class="external-link">desc</a></span><span class="op">(</span><span class="va">dep_dist</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>rank<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span>, is_focus<span class="op">=</span><span class="va">o_name</span><span class="op">==</span><span class="va">d_name</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">ungroup</a></span><span class="op">(</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">plot_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Draw background map tiles (equivalent to geom_sf()).</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span></span>
<span>    data<span class="op">=</span><span class="va">grid</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_drop_geometry</a></span><span class="op">(</span><span class="op">)</span>  <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">inner_join</a></span><span class="op">(</span><span class="va">france_grid</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>d_col<span class="op">=</span><span class="va">col</span>, d_row<span class="op">=</span><span class="va">row</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">10</span>, y <span class="op">=</span> <span class="fl">.5</span><span class="op">)</span>,</span>
<span>    width<span class="op">=</span><span class="fl">20</span>, height<span class="op">=</span><span class="fl">1</span>,</span>
<span>    fill<span class="op">=</span><span class="st">"#d9d9d9"</span>, colour<span class="op">=</span><span class="st">"#969696"</span>, linewidth<span class="op">=</span><span class="fl">.1</span>, alpha<span class="op">=</span><span class="fl">.9</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Draw column charts.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rank</span><span class="op">&lt;</span><span class="fl">21</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">rank</span>, y<span class="op">=</span><span class="va">dep_dist</span><span class="op">)</span>, width<span class="op">=</span><span class="fl">1</span>, fill<span class="op">=</span><span class="st">"#cb181d"</span>, alpha<span class="op">=</span><span class="fl">.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Draw text labels for each département.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span>data<span class="op">=</span><span class="va">.</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">o_name</span><span class="op">==</span><span class="va">d_name</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="fl">20</span>, y<span class="op">=</span><span class="fl">.95</span>,</span>
<span>                                                   label<span class="op">=</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">d_name</span>, <span class="st">"^.{3}"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            colour<span class="op">=</span><span class="st">"#252525"</span>, alpha<span class="op">=</span><span class="fl">0.4</span>, size<span class="op">=</span><span class="fl">3.2</span>, show.legend<span class="op">=</span><span class="cn">FALSE</span>,</span>
<span>            hjust<span class="op">=</span><span class="st">"right"</span>, vjust<span class="op">=</span><span class="st">"top"</span>, fontface<span class="op">=</span><span class="st">"bold"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid</a></span><span class="op">(</span><span class="op">-</span><span class="va">d_row</span><span class="op">~</span><span class="va">d_col</span><span class="op">)</span></span></code></pre></div>
<p>A quick explanation of the ggplot2 spec:</p>
<ol style="list-style-type: decimal">
<li>
<em>Data</em>: A staging dataset (<code>plot_data</code>) is
created. In order to bring in the <code>col</code> and <code>row</code>
indexes for faceting as a grid, we join <code>france_ods</code> on the
gridmap <code>solution</code> dataset, and on the ‘destination’
département, which are the larger reference cells in our gridmap – the
bars representing inverse distances to those département, we call
‘origins’. In the mutate, we scale 1/distance between 0 and 1, using the
minimum distance between any origin-destination département, after
having recoded distances of 0 for départements of the same
<code>origin-destination</code>. After grouping by these destinations,
we rank ‘origin’ départements on their proximity
(<code>rank</code>).<br>
</li>
<li>
<em>Encoding</em>: Bars whose length (<code>y=</code>) varies
according to inverse distance and categorical position (<code>x=</code>)
according to <code>rank</code> proximity to the ‘destination’
département.</li>
<li>
<em>Marks</em>: <code><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col()</a></code> for the bars, with the top
20 most proximate ‘origin’ départements filtered;
<code><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text()</a></code> for drawing ‘destination’ département
labels.</li>
<li>
<em>Facets</em>: <code><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid()</a></code> with a slight hack on the
row variable (<code>-row</code>) as gridmappr’s origin
[<em>min-row</em>, <em>min-col</em>] is the bottom-left cell in the grid
whereas for <code><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid()</a></code> the origin is the top-left.</li>
</ol>
</div>
<div class="section level2">
<h2 id="using-gridmap-allocations-with-ggplot2-extensions">Using gridmap allocations with ggplot2 extensions<a class="anchor" aria-label="anchor" href="#using-gridmap-allocations-with-ggplot2-extensions"></a>
</h2>
<p>For a very user-friendly way of drawing gridmaps from
<code>gridmappr</code>-generated layouts, we are in the process of
incporporating <code>gridmappr</code> into the excellent <a href="https://r-tmap.github.io/tmap/" class="external-link"><code>tmap</code></a> package.</p>
<p>Although there are benefits to designing gridmaps within standard
declarative ggplot2, for those preferring a slightly higher-level
interface than demonstrated here, <code>gridmappr</code> generated
layouts can also be used in <a href="https://hafen.github.io/geofacet/" class="external-link"><code>geofacet</code></a>.
Since <code><a href="../reference/points_to_grid.html">points_to_grid()</a></code> returns grid allocations in the same
data structure as required by <code>geofacet</code>, this is reasonably
straightforward. In the code below, we slightly reorganise the variables
in the gridmap <code>solution</code> file and transpose the
<code>row</code> column up-front, as was necessary with the
<code><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid()</a></code> example. This allocation
(<code>grid_data</code>) is then supplied to
<code><a href="https://hafen.github.io/geofacet/reference/facet_geo.html" class="external-link">facet_geo()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Slight edits to solution dataset, as required by geofacet.</span></span>
<span><span class="va">grid_data</span> <span class="op">&lt;-</span> <span class="va">solution</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co"># A code variable is required.</span></span>
<span>    code<span class="op">=</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>    <span class="co"># Transpose row, due to inverse origin.</span></span>
<span>    row<span class="op">=</span><span class="op">(</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">row</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">row</span><span class="op">)</span><span class="op">)</span><span class="op">-</span><span class="va">row</span><span class="op">)</span>,</span>
<span>    name<span class="op">=</span><span class="va">area_name</span></span>
<span>    <span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">row</span>, <span class="va">col</span>, <span class="va">code</span>, <span class="va">name</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Cast name as factor and set levels, so that exactly match with plot_data.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>name<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> </span>
<span></span>
<span>  </span>
<span><span class="va">plot_data</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">o_name</span>, <span class="va">d_name</span>, <span class="va">dep_dist</span>, <span class="va">rank</span>, name<span class="op">=</span><span class="va">d_name</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">rank</span><span class="op">&lt;</span><span class="fl">21</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="co"># Cast name as factor and set levels, so that exactly match with grid_data.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>name<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">name</span>, levels<span class="op">=</span><span class="va">grid_data</span><span class="op">$</span><span class="va">name</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Draw column charts.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_bar.html" class="external-link">geom_col</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">rank</span>, y<span class="op">=</span><span class="va">dep_dist</span><span class="op">)</span>, width<span class="op">=</span><span class="fl">1</span>, fill<span class="op">=</span><span class="st">"#cb181d"</span>, alpha<span class="op">=</span><span class="fl">.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Call facet function and supply 'name' and the 'grid_data'. </span></span>
<span>  <span class="fu"><a href="https://hafen.github.io/geofacet/reference/facet_geo.html" class="external-link">facet_geo</a></span><span class="op">(</span><span class="op">~</span><span class="va">name</span>, grid<span class="op">=</span><span class="va">grid_data</span>, labeller <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/as_labeller.html" class="external-link">as_labeller</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_extract.html" class="external-link">str_extract</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"^.{3}"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>strip.text <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>face<span class="op">=</span><span class="st">"bold"</span>, size<span class="op">=</span><span class="fl">10</span>, colour<span class="op">=</span><span class="st">"#636363"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="../reference/figures/france-dist-geofacet.svg" style="width:50.0%"></p>
<p>TODO: The data in some cells do not display. I’ve investiagted the
most likely causes, so more detective work needed to fix this.</p>
</div>
<div class="section level2">
<h2 id="gridmap-as-geographically-arranged-geom_sfs-od-maps">Gridmap as geographically arranged <code>geom_sfs</code> (OD
Maps)<a class="anchor" aria-label="anchor" href="#gridmap-as-geographically-arranged-geom_sfs-od-maps"></a>
</h2>
<p>So far we have generated gridmap graphics as standard thematic maps
using a polygon object and <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf()</a></code>; and as geographically
arranged plot objects (glyphmaps) with <code><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid()</a></code>.
Combining both approaches – placing standard thematic maps with a
further geographical arrangement (using <code><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid()</a></code>) –
allows the creation of <a href="https://openaccess.city.ac.uk/id/eprint/537/" class="external-link">OD Maps</a>. With
this map-within-map layout, we can encode distances to ‘destination’
départements not using bars, but with cells of ‘origin’ départements
arranged geographically.</p>
<p><img src="../reference/figures/france-od-map.svg"></p>
<p>The ggplot2 spec for creating the OD map:</p>
<ul>
<li>
<em>1. Data</em>:
<ul>
<li>Take the staged dataset and join twice on the <code>solution</code>
dataset and then on the geometry data, either real
(<code>france_deps</code>) or gridded (<code>france_grid</code>).</li>
<li>The first join, on <code>d_name</code>. The map in the figure is a
D-OD map. The larger (<em>focus</em>) grid cells correspond to
‘destination’ départements; the smaller cells are ‘origin’ départements
coloured according to distances from the larger (focus) cells.</li>
<li>The second join , on <code>o_name</code>, mirrors this approach,
except of course the shared column on which the datasets are
joined.</li>
<li>The third join is on the <code>geometry</code> data, and we here
using the ‘origin’ <code>o_name</code> as the joining variable. Note
that we join either on <code>france_grid</code>, for smaller maps in
gridded space, or <code>france_dep</code> for smaller maps with real
geography.</li>
<li>Finally in the <code><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate()</a></code> we specially identify the
département in focus (<code>is_focus</code>), ‘destinations’ in this
case.</li>
</ul>
</li>
<li>
<em>2. Encoding</em>:
<ul>
<li>Gridmap cells are coloured according to the distances
(<code>fill=dist</code>).</li>
<li>Text labels for destination (focus) département are drawn in the
top-right corner of larger cells. Note that the coordinate space here is
that from the <code>gridmap</code> dataset and so the <code>x,y</code>
location of département labels are derived from the bounding box object
(<code>bbox_grid</code>).</li>
</ul>
</li>
<li>
<em>3. Marks</em>: <code><a href="https://ggplot2.tidyverse.org/reference/ggsf.html" class="external-link">geom_sf()</a></code> for drawing the small
gridcell maps; <code><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text()</a></code> for drawing the labels;
<code><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile()</a></code> for drawing the background cells.</li>
<li>
<em>4. Scale</em>: <code><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html" class="external-link">scale_fill_distiller()</a></code> for a
continuous colour scheme using the ColorBrewer <code>Reds</code>
palette.</li>
<li>
<em>5. Facets</em>: <code><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html" class="external-link">facet_grid()</a></code> for effecting the
map-within-map layout.</li>
</ul>
</div>
<div class="section level2">
<h2 id="further-reading">Further Reading<a class="anchor" aria-label="anchor" href="#further-reading"></a>
</h2>
<ul>
<li><p>Beecham, R. (2025) ‘Visualization for Social Data Science’,
<em>CRC Press</em>, ISBN: <a href="https://www.routledge.com/Visualization-for-Social-Data-Science/Beecham/p/book/9781032259710" class="external-link">9781032259710</a>.</p></li>
<li><p>Beecham, R. and Slingsby, A. (2019) ‘Characterising labour market
self-containment in London with geographically arranged small
multiples’, <em>Environment and Planning A: Economy and Space</em>,
51(6), pp. 1217–1224. doi: <a href="https://journals.sagepub.com/doi/10.1177/0308518X19850580" class="external-link">10.1177/0308518X19850580</a>.</p></li>
<li><p>Wood, J., Dykes, J. and Slingsby, A. (2010) ‘Visualisation of
Origins, Destinations and Flows with OD Maps’, <em>The Cartographic
Journal</em>, 47(2), pp. 117–129. doi: <a href="https://doi.org/10.1179/000870410X12658023467367" class="external-link">10.1179/000870410x12658023467367</a>.</p></li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Roger Beecham.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
